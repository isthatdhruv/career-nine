<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Take Assessment</title>
  <style>
    :root{--accent:#0b74de;--green:#078a17;--red:#d12b2b;--purple:#667eea;--purple2:#764ba2}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f6f8fb;color:#111}
    .wrap{max-width:900px;margin:1.5rem auto;padding:1rem}
    header{display:flex;align-items:center;gap:1rem}
    h1{font-size:1.1rem;margin:0}
    .card{background:#fff;padding:1rem;border-radius:8px;border:1px solid #e6eefc;margin-top:1rem}
    .row{display:flex;gap:0.75rem;flex-wrap:wrap}
    label{display:block;font-size:.9rem;margin:.25rem 0}
    select,input[type="text"],input[type="number"],input[type="date"]{padding:.5rem;border:1px solid #cddbe8;border-radius:6px;width:100%;box-sizing:border-box}
    .section{margin-top:1rem;padding:.75rem;border-radius:6px;border:1px dashed #e0e6ef}
    .q{margin-top:.75rem}
    .options{margin-left:0.5rem}
    button{background:var(--accent);color:#fff;border:0;padding:.5rem .75rem;border-radius:6px;cursor:pointer}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .muted{color:#666;font-size:.9rem}
    .hint{font-size:.85rem;color:#666;margin-top:.5rem}
    .controls{display:flex;gap:.5rem;margin-top:1rem}
    .progress{margin-top:.5rem;font-size:.9rem;color:#444}
    .badge{display:inline-block;padding:.25rem .5rem;border-radius:6px;color:#fff;font-size:.8rem}
    .badge.green{background:var(--green)}
    .badge.red{background:var(--red)}
    .section-list{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
    .section-item{padding:.5rem .75rem;border-radius:6px;border:1px solid #dfe9f6;background:#fff;cursor:pointer}
    .section-item.active{outline:2px solid var(--accent)}
    small.error{color:#a00}
    .demo-field{margin-bottom:1rem}
    .demo-field label{font-weight:500;color:#4a5568;margin-bottom:.25rem}
    .demo-field .required{color:#e53e3e}
    .demo-field .field-error{color:#e53e3e;font-size:.85rem;margin-top:.25rem}
    .demo-radio-group{display:flex;gap:.5rem;flex-wrap:wrap}
    .demo-radio-label{padding:.5rem .75rem;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:.5rem;transition:all .2s}
    .demo-radio-label.selected{border-color:var(--purple);background:#eef2ff}
    .demo-radio-label input{width:18px;height:18px;accent-color:var(--purple)}
    .demo-checkbox-group{display:flex;flex-wrap:wrap;gap:.5rem}
    .demo-checkbox-label{padding:.4rem .75rem;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:.5rem;transition:all .2s}
    .demo-checkbox-label.selected{border-color:var(--purple);background:#eef2ff}
    .demo-checkbox-label input{width:16px;height:16px;accent-color:var(--purple)}
    .demo-section-title{font-size:1rem;font-weight:600;color:#4a5568;margin-bottom:.75rem;padding-bottom:.5rem;border-bottom:2px solid #e2e8f0}
    .btn-continue{background:linear-gradient(135deg,var(--purple),var(--purple2));color:#fff;border:0;padding:.75rem 1.5rem;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;width:100%;margin-top:1rem;box-shadow:0 4px 15px rgba(102,126,234,.4)}
    .btn-continue:hover{box-shadow:0 6px 20px rgba(102,126,234,.5);transform:translateY(-1px)}
    .btn-continue:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
    @media (max-width:640px){.row{flex-direction:column}.demo-radio-group{flex-direction:column}}
  </style>
</head>
<body>
  <main class="wrap" id="app">
    <header>
      <div style="width:44px;height:44px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">Q</div>
      <div>
        <h1>Assessment — take now</h1>
        <div class="muted">Answers saved locally until submit.</div>
      </div>
    </header>

    <div class="card" id="setup">
      <div class="row">
        <div style="flex:1 1 220px">
          <label for="langSelect">Language (initial)</label>
          <select id="langSelect"></select>
        </div>
        <div style="width:140px">
          <label class="muted">&nbsp;</label>
          <div><button id="beginBtn">Begin</button></div>
        </div>
      </div>
      <div class="hint" id="setupHint">Loading assessment…</div>
    </div>

    <!-- Demographics Card -->
    <div id="demographicsCard" class="card" style="display:none">
      <h3 style="margin-top:0">Demographic Details</h3>
      <p class="muted" style="margin-top:0">Please provide your information to continue</p>
      <div id="demographicsForm"></div>
      <div id="demoError" class="hint" style="color:#e53e3e"></div>
      <button class="btn-continue" id="demoContinueBtn" type="button">Save and Continue</button>
    </div>

    <div id="instructionsCard" class="card" style="display:none">
      <h3>Instructions</h3>
      <div id="allInstructions"></div>
      <div class="hint">Select a section to start. Completed sections are green, incomplete are red.</div>
      <div class="section-list" id="sectionList"></div>
    </div>

    <div id="assessment" style="display:none">
      <div id="meta" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong id="assessTitle"></strong>
            <div id="assessTool" class="muted"></div>
            <div id="assessInstr" class="hint"></div>
          </div>
          <div>
            <div class="progress" id="progress">0 / 0</div>
            <div class="muted" id="timeInfo"></div>
          </div>
        </div>
      </div>

      <form id="assessForm"></form>

      <div class="controls">
        <button id="saveBtn" type="button">Save Progress</button>
        <button id="submitBtn" type="button">Submit</button>
        <div id="message" class="muted" style="margin-left:0.5rem"></div>
      </div>
    </div>
  </main>

  <script src="analytics.js"></script>
  <script>
    // load assessment.json
    let assessment = null;
    let studentKey = null;
    let currentSection = null;
    let currentQuestionIndex = 0;
    let demographicFields = [];
    let demographicValues = {};

    const API_URL = localStorage.getItem('apiUrl') || (window.location.hostname === 'localhost' ? 'http://localhost:8091' : '');

    const langSelect = document.getElementById('langSelect');
    const beginBtn = document.getElementById('beginBtn');
    const setupHint = document.getElementById('setupHint');
    const instructionsCard = document.getElementById('instructionsCard');
    const allInstructions = document.getElementById('allInstructions');
    const sectionList = document.getElementById('sectionList');
    const demographicsCard = document.getElementById('demographicsCard');
    const demographicsForm = document.getElementById('demographicsForm');
    const demoContinueBtn = document.getElementById('demoContinueBtn');
    const demoError = document.getElementById('demoError');

    const assessTitle = document.getElementById('assessTitle');
    const assessTool = document.getElementById('assessTool');
    const assessInstr = document.getElementById('assessInstr');
    const assessmentDiv = document.getElementById('assessment');
    const form = document.getElementById('assessForm');
    const progressEl = document.getElementById('progress');
    const saveBtn = document.getElementById('saveBtn');
    const submitBtn = document.getElementById('submitBtn');
    const message = document.getElementById('message');

    // Default demographic fields (used when no configured fields exist)
    const DEFAULT_DEMOGRAPHICS = [
      {
        fieldId: -1, fieldName: 'student_name', displayLabel: 'What is your name?',
        fieldSource: 'SYSTEM', systemFieldKey: 'name', dataType: 'TEXT',
        validationRegex: '^[a-zA-Z\\s]+$', validationMessage: 'Name should only contain letters and spaces',
        minValue: 2, maxValue: 100, placeholder: 'Enter your name',
        isMandatory: true, options: []
      },
      {
        fieldId: -2, fieldName: 'student_gender', displayLabel: 'Are you a boy or a girl?',
        fieldSource: 'SYSTEM', systemFieldKey: 'gender', dataType: 'SELECT_SINGLE',
        isMandatory: true, options: [
          { optionId: 1, optionValue: 'Boy', optionLabel: 'Boy' },
          { optionId: 2, optionValue: 'Girl', optionLabel: 'Girl' }
        ]
      },
      {
        fieldId: -3, fieldName: 'student_grade', displayLabel: 'What grade are you in?',
        fieldSource: 'SYSTEM', systemFieldKey: 'studentClass', dataType: 'SELECT_SINGLE',
        isMandatory: true, options: [
          { optionId: 3, optionValue: '3', optionLabel: '3rd Grade' },
          { optionId: 4, optionValue: '4', optionLabel: '4th Grade' },
          { optionId: 5, optionValue: '5', optionLabel: '5th Grade' }
        ]
      },
      {
        fieldId: -4, fieldName: 'school_board', displayLabel: 'Which school board do you study in?',
        fieldSource: 'SYSTEM', systemFieldKey: 'schoolBoard', dataType: 'SELECT_SINGLE',
        isMandatory: true, options: [
          { optionId: 6, optionValue: 'CBSE', optionLabel: 'CBSE' },
          { optionId: 7, optionValue: 'ICSE', optionLabel: 'ICSE' },
          { optionId: 8, optionValue: 'State Board', optionLabel: 'State Board' },
          { optionId: 9, optionValue: 'IB / IGCSE', optionLabel: 'IB / IGCSE' },
          { optionId: 10, optionValue: "I don't know", optionLabel: "I don't know" }
        ]
      },
      {
        fieldId: -5, fieldName: 'student_siblings', displayLabel: 'How many brothers and sisters do you have?',
        fieldSource: 'SYSTEM', systemFieldKey: 'sibling', dataType: 'SELECT_SINGLE',
        isMandatory: true, options: [
          { optionId: 11, optionValue: '0', optionLabel: '0 (I am an only child)' },
          { optionId: 12, optionValue: '1', optionLabel: '1' },
          { optionId: 13, optionValue: '2', optionLabel: '2' },
          { optionId: 14, optionValue: '3', optionLabel: '3 or more' }
        ]
      },
      {
        fieldId: -6, fieldName: 'living_with', displayLabel: 'Who do you live with?',
        fieldSource: 'SYSTEM', systemFieldKey: 'family', dataType: 'SELECT_SINGLE',
        isMandatory: true, options: [
          { optionId: 15, optionValue: 'Small Family', optionLabel: 'Just my parents and siblings (Small Family)' },
          { optionId: 16, optionValue: 'Big/Joint Family', optionLabel: 'My parents, siblings, grandparents, uncles, or aunts (Big/Joint Family)' },
          { optionId: 17, optionValue: 'Other', optionLabel: 'Other' }
        ]
      }
    ];

    async function loadAssessment() {
      try {
        const res = await fetch('./assessment.json');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        assessment = data[0];
        studentKey = 'assessment_answers_' + assessment.questionnaireId;
        initLangs();
        setupHint.textContent = 'Select language and click Begin';
      } catch (e) {
        setupHint.textContent = 'Failed to load assessment.json';
        beginBtn.disabled = true;
      }
    }

    async function loadDemographicFields() {
      const userStudentId = localStorage.getItem('userStudentId');
      const assessmentId = localStorage.getItem('assessmentId');

      if (!API_URL || !userStudentId || !assessmentId) {
        return null; // No backend available - use defaults
      }

      try {
        const res = await fetch(API_URL + '/student-demographics/fields/' + assessmentId + '/' + userStudentId);
        if (!res.ok) return null;
        const fields = await res.json();
        return fields.length > 0 ? fields : null;
      } catch (e) {
        console.warn('Could not load demographic fields from backend:', e);
        return null;
      }
    }

    function initLangs() {
      langSelect.innerHTML = '';
      (assessment.languages || []).forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.language.languageId;
        opt.textContent = l.language.languageName;
        langSelect.appendChild(opt);
      });
      if (langSelect.options.length) langSelect.value = langSelect.options[0].value;
    }

    // ---- Demographics rendering ----

    function renderDemographicsForm(fields) {
      demographicFields = fields;
      demographicsForm.innerHTML = '';
      demographicValues = {};
      demoError.textContent = '';

      fields.forEach(field => {
        const label = field.customLabel || field.displayLabel;
        const wrapper = document.createElement('div');
        wrapper.className = 'demo-field';
        wrapper.dataset.fieldId = field.fieldId;

        const lbl = document.createElement('label');
        lbl.textContent = label;
        if (field.isMandatory) {
          const req = document.createElement('span');
          req.className = 'required';
          req.textContent = ' *';
          lbl.appendChild(req);
        }
        wrapper.appendChild(lbl);

        // Pre-fill value
        const currentVal = field.currentValue || field.defaultValue || '';
        demographicValues[field.fieldId] = currentVal;

        switch (field.dataType) {
          case 'TEXT':
            renderTextField(wrapper, field, currentVal);
            break;
          case 'NUMBER':
            renderNumberField(wrapper, field, currentVal);
            break;
          case 'DATE':
            renderDateField(wrapper, field, currentVal);
            break;
          case 'SELECT_SINGLE':
            if (field.options && field.options.length <= 4) {
              renderRadioField(wrapper, field, currentVal);
            } else {
              renderDropdownField(wrapper, field, currentVal);
            }
            break;
          case 'SELECT_MULTI':
            renderCheckboxField(wrapper, field, currentVal);
            break;
          default:
            renderTextField(wrapper, field, currentVal);
        }

        demographicsForm.appendChild(wrapper);
      });
    }

    function renderTextField(wrapper, field, value) {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = field.placeholder || '';
      input.value = value;
      input.addEventListener('input', () => { demographicValues[field.fieldId] = input.value; });
      wrapper.appendChild(input);
    }

    function renderNumberField(wrapper, field, value) {
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = field.placeholder || '';
      input.value = value;
      if (field.minValue != null) input.min = field.minValue;
      if (field.maxValue != null) input.max = field.maxValue;
      input.addEventListener('input', () => { demographicValues[field.fieldId] = input.value; });
      wrapper.appendChild(input);
    }

    function renderDateField(wrapper, field, value) {
      const input = document.createElement('input');
      input.type = 'date';
      input.value = value;
      input.addEventListener('input', () => { demographicValues[field.fieldId] = input.value; });
      wrapper.appendChild(input);
    }

    function renderRadioField(wrapper, field, value) {
      const group = document.createElement('div');
      group.className = 'demo-radio-group';
      (field.options || []).forEach(opt => {
        const lbl = document.createElement('label');
        lbl.className = 'demo-radio-label' + (value === opt.optionValue ? ' selected' : '');
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'demo_' + field.fieldId;
        radio.value = opt.optionValue;
        radio.checked = value === opt.optionValue;
        radio.addEventListener('change', () => {
          demographicValues[field.fieldId] = opt.optionValue;
          group.querySelectorAll('.demo-radio-label').forEach(l => l.classList.remove('selected'));
          lbl.classList.add('selected');
        });
        lbl.appendChild(radio);
        const txt = document.createElement('span');
        txt.textContent = opt.optionLabel;
        lbl.appendChild(txt);
        group.appendChild(lbl);
      });
      wrapper.appendChild(group);
    }

    function renderDropdownField(wrapper, field, value) {
      const sel = document.createElement('select');
      const defOpt = document.createElement('option');
      defOpt.value = '';
      defOpt.textContent = 'Select an option';
      sel.appendChild(defOpt);
      (field.options || []).forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.optionValue;
        o.textContent = opt.optionLabel;
        if (value === opt.optionValue) o.selected = true;
        sel.appendChild(o);
      });
      sel.addEventListener('change', () => { demographicValues[field.fieldId] = sel.value; });
      wrapper.appendChild(sel);
    }

    function renderCheckboxField(wrapper, field, value) {
      const selectedValues = value ? value.split(',') : [];
      demographicValues[field.fieldId] = selectedValues.join(',');
      const group = document.createElement('div');
      group.className = 'demo-checkbox-group';
      (field.options || []).forEach(opt => {
        const isChecked = selectedValues.includes(opt.optionValue);
        const lbl = document.createElement('label');
        lbl.className = 'demo-checkbox-label' + (isChecked ? ' selected' : '');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = opt.optionValue;
        cb.checked = isChecked;
        cb.addEventListener('change', () => {
          const current = (demographicValues[field.fieldId] || '').split(',').filter(v => v);
          if (cb.checked) {
            current.push(opt.optionValue);
            lbl.classList.add('selected');
          } else {
            const idx = current.indexOf(opt.optionValue);
            if (idx > -1) current.splice(idx, 1);
            lbl.classList.remove('selected');
          }
          demographicValues[field.fieldId] = current.join(',');
        });
        lbl.appendChild(cb);
        const txt = document.createElement('span');
        txt.textContent = opt.optionLabel;
        lbl.appendChild(txt);
        group.appendChild(lbl);
      });
      wrapper.appendChild(group);
    }

    function validateDemographics() {
      const errors = [];
      for (const field of demographicFields) {
        const val = (demographicValues[field.fieldId] || '').trim();
        const label = field.customLabel || field.displayLabel;
        if (field.isMandatory && !val) {
          errors.push(label + ' is required');
          continue;
        }
        if (val && field.dataType === 'TEXT' && field.validationRegex) {
          try {
            if (!new RegExp(field.validationRegex).test(val)) {
              errors.push(field.validationMessage || 'Invalid value for ' + label);
            }
          } catch (e) { /* skip invalid regex */ }
        }
        if (val && field.dataType === 'TEXT' && field.minValue && val.length < field.minValue) {
          errors.push(label + ' must be at least ' + field.minValue + ' characters');
        }
      }
      return errors;
    }

    async function submitDemographics() {
      const errors = validateDemographics();
      if (errors.length > 0) {
        demoError.textContent = errors[0];
        return false;
      }
      demoError.textContent = '';

      const userStudentId = localStorage.getItem('userStudentId');
      const assessmentId = localStorage.getItem('assessmentId');

      // If backend is available, submit to API
      if (API_URL && userStudentId && assessmentId) {
        try {
          const responses = demographicFields.map(f => ({
            fieldId: f.fieldId,
            value: demographicValues[f.fieldId] || ''
          }));

          const res = await fetch(API_URL + '/student-demographics/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userStudentId: Number(userStudentId),
              assessmentId: Number(assessmentId),
              responses: responses
            })
          });

          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            if (errData.validationErrors) {
              demoError.textContent = errData.validationErrors[0];
              return false;
            }
            demoError.textContent = errData.error || 'Failed to save demographics';
            return false;
          }
        } catch (e) {
          console.warn('Backend submit failed, saving locally:', e);
        }
      }

      // Also save demographics locally (for offline/local use)
      const demoData = {};
      demographicFields.forEach(f => {
        demoData[f.fieldName] = demographicValues[f.fieldId] || '';
      });
      localStorage.setItem('demographics_' + (assessment ? assessment.questionnaireId : 'local'), JSON.stringify(demoData));

      // Store student name from demographics (for the assessment answers)
      const nameField = demographicFields.find(f => f.fieldName === 'student_name' || f.systemFieldKey === 'name');
      if (nameField) {
        localStorage.setItem('studentName', demographicValues[nameField.fieldId] || '');
      }

      return true;
    }

    // ---- Assessment flow ----

    function showAllInstructions() {
      allInstructions.innerHTML = '';
      (assessment.languages || []).forEach(l => {
        const el = document.createElement('div');
        el.innerHTML = '<strong>' + (l.language.languageName || 'Language') + ':</strong> ' + (l.instructions || '');
        allInstructions.appendChild(el);
      });
      renderSectionList();
      instructionsCard.style.display = 'block';
    }

    function renderSectionList() {
      sectionList.innerHTML = '';
      const saved = JSON.parse(localStorage.getItem(studentKey) || 'null');
      (assessment.sections || []).sort((a,b)=>Number(a.order)-Number(b.order)).forEach(sec => {
        const completed = isSectionCompleted(sec, saved);
        const btn = document.createElement('div');
        btn.className = 'section-item';
        btn.dataset.id = sec.section.sectionId;
        btn.innerHTML = `<div style="display:flex;gap:.5rem;align-items:center">
                          <div>${sec.section.sectionName}</div>
                          <div class="badge ${completed ? 'green' : 'red'}">${completed ? 'Completed' : 'Incomplete'}</div>
                         </div>`;
        btn.addEventListener('click', () => {
          document.querySelectorAll('.section-item').forEach(i=>i.classList.remove('active'));
          btn.classList.add('active');
          selectSection(sec);
        });
        sectionList.appendChild(btn);
      });
    }

    function isSectionCompleted(section, saved) {
      if (!saved || !saved.answers) return false;
      const qIds = (section.questions || []).map(q=>q.question.questionId);
      if (qIds.length === 0) return false;
      const answeredQuestionIds = saved.answers.map(a=>a.questionId);
      return qIds.every(qid => answeredQuestionIds.includes(qid) && (saved.answers.find(a=>a.questionId===qid).answers.length>0));
    }

    function selectSection(sec) {
      currentSection = sec;
      assessTitle.textContent = assessment.name || 'Untitled';
      assessTool.textContent = assessment.tool?.name ? 'Tool: ' + assessment.tool.name : '';
      const selLang = Number(langSelect.value);
      const inst = (sec.instruction || []).find(i => i.language?.languageId === selLang);
      assessInstr.textContent = inst ? inst.instructionText : '';
      renderSectionQuestions(sec);
      assessmentDiv.style.display = 'block';
      document.getElementById('instructionsCard').scrollIntoView({behavior:'smooth'});
    }

    function renderSectionQuestions(sec) {
      form.innerHTML = '';
      const questions = (sec.questions || []).sort((a,b)=>Number(a.order)-Number(b.order));
      const saved = JSON.parse(localStorage.getItem(studentKey) || 'null');
      const answeredIds = saved ? saved.answers.map(a=>a.questionId) : [];
      let firstUnansweredIndex = questions.findIndex(qLink => !answeredIds.includes(qLink.question.questionId));
      if (firstUnansweredIndex === -1) firstUnansweredIndex = 0;
      currentQuestionIndex = firstUnansweredIndex;
      showQuestionAtIndex(questions, currentQuestionIndex);
      updateProgressForSection(sec, saved);
    }

    function showQuestionAtIndex(questions, idx) {
      form.innerHTML = '';
      const qLink = questions[idx];
      if (!qLink) return;
      const q = qLink.question;
      const qtitle = (q.languageQuestions && q.languageQuestions.find(lq=>lq.language?.languageId===Number(langSelect.value))?.questionText) || q.questionText || 'Question';
      const qnum = document.createElement('div'); qnum.innerHTML = '<strong>Q:</strong> ' + qtitle;
      const qEl = document.createElement('div'); qEl.className = 'q';
      qEl.appendChild(qnum);
      const opts = document.createElement('div'); opts.className='options';
      const max = Number(q.maxOptionsAllowed) || 0;
      const isMultiple = q.questionType === 'multiple-choice' || max !== 1;
      (q.options || []).forEach(opt => {
        const id = 'q' + q.questionId + '_o' + opt.optionId;
        const wrapper = document.createElement('div');
        const input = document.createElement('input');
        input.type = isMultiple ? 'checkbox' : 'radio';
        input.name = 'q_' + q.questionId;
        input.value = opt.optionId;
        input.id = id;
        const label = document.createElement('label');
        label.htmlFor = id;
        label.style.marginLeft = '6px';
        label.textContent = opt.optionText;
        wrapper.appendChild(input);
        wrapper.appendChild(label);
        opts.appendChild(wrapper);
      });
      if (max > 0) {
        const hint = document.createElement('div'); hint.className='muted'; hint.textContent = 'Select up to ' + max + ' option(s).';
        qEl.appendChild(hint);
      }
      qEl.appendChild(opts);

      const ctrl = document.createElement('div'); ctrl.style.marginTop = '.75rem';
      const prevBtn = document.createElement('button');
      prevBtn.type = 'button';
      prevBtn.style.marginLeft = '0.5rem';
      prevBtn.textContent = 'Prev';
      if (idx > 0) ctrl.appendChild(prevBtn);

      if (idx < questions.length - 1) {
        const nextBtn = document.createElement('button');
        nextBtn.type = 'button';
        nextBtn.textContent = 'Next';
        ctrl.appendChild(nextBtn);
        nextBtn.addEventListener('click', () => {
          const selected = Array.from(form.querySelectorAll('input[name="q_' + q.questionId + '"]:checked')).map(i => Number(i.value));
          saveAnswer(q.questionId, selected);
          if (window.MouseTracker) window.MouseTracker.endQuestion(q.questionId);
          currentQuestionIndex = idx + 1;
          showQuestionAtIndex(questions, currentQuestionIndex);
          updateProgressForSection(currentSection, JSON.parse(localStorage.getItem(studentKey) || 'null'));
        });
      } else {
        const finishBtn = document.createElement('button');
        finishBtn.type = 'button';
        finishBtn.style.marginLeft = '0.5rem';
        finishBtn.textContent = 'Finish Section';
        ctrl.appendChild(finishBtn);
        finishBtn.addEventListener('click', () => {
          const selected = Array.from(form.querySelectorAll('input[name="q_' + q.questionId + '"]:checked')).map(i => Number(i.value));
          saveAnswer(q.questionId, selected);
          if (window.MouseTracker) window.MouseTracker.endQuestion(q.questionId);
          renderSectionList();
          message.textContent = 'Section completed';
          setTimeout(() => { message.textContent = ''; }, 1500);
          assessmentDiv.style.display = 'none';
          document.getElementById('instructionsCard').scrollIntoView({ behavior: 'smooth' });
        });
      }

      prevBtn.addEventListener('click', () => {
        if (idx > 0) {
          const selected = Array.from(form.querySelectorAll('input[name="q_' + q.questionId + '"]:checked')).map(i => Number(i.value));
          saveAnswer(q.questionId, selected);
          if (window.MouseTracker) window.MouseTracker.endQuestion(q.questionId);
          currentQuestionIndex = idx - 1;
          showQuestionAtIndex(questions, currentQuestionIndex);
          updateProgressForSection(currentSection, JSON.parse(localStorage.getItem(studentKey) || 'null'));
        }
      });
      qEl.appendChild(ctrl);
      form.appendChild(qEl);

      // restore existing answers
      const saved = JSON.parse(localStorage.getItem(studentKey) || 'null');
      if (saved && saved.answers) {
        const qans = (saved.answers.find(a=>a.questionId === q.questionId) || {}).answers || [];
        qans.forEach(val => {
          const inp = form.querySelector('input[value="'+val+'"]');
          if (inp) inp.checked = true;
        });
      }
      if (window.MouseTracker) window.MouseTracker.startQuestion(q.questionId);
    }

    function updateProgressForSection(sec, saved) {
      const total = (sec.questions || []).length;
      const answered = (saved && saved.answers) ? (sec.questions || []).filter(sq=>saved.answers.some(a=>a.questionId===sq.question.questionId && a.answers.length>0)).length : 0;
      progressEl.textContent = answered + ' / ' + total;
    }

    function saveAnswer(qid, selectedArray) {
      const studentNameVal = localStorage.getItem('studentName') || null;
      const saved = JSON.parse(localStorage.getItem(studentKey) || 'null') || { questionnaireId: assessment.questionnaireId, student: studentNameVal, language: Number(langSelect.value), savedAt: new Date().toISOString(), answers: [] };
      saved.student = studentNameVal || saved.student;
      saved.language = Number(langSelect.value);
      saved.savedAt = new Date().toISOString();
      const idx = saved.answers.findIndex(a=>a.questionId===qid);
      if (idx === -1) {
        saved.answers.push({ questionId: qid, answers: selectedArray });
      } else {
        saved.answers[idx].answers = selectedArray;
      }
      localStorage.setItem(studentKey, JSON.stringify(saved));
      message.textContent = 'Saved';
      setTimeout(()=>message.textContent='',900);
      renderSectionList();
    }

    function collectAnswers() {
      return JSON.parse(localStorage.getItem(studentKey) || 'null');
    }

    function submitAssessment() {
      const data = collectAnswers();
      if (!data || !data.answers || data.answers.length === 0) { message.textContent='Please answer at least one question'; return; }
      data.submittedAt = new Date().toISOString();
      localStorage.setItem('submission_' + assessment.questionnaireId, JSON.stringify(data));
      if (window.MouseTracker) localStorage.setItem('analytics_' + assessment.questionnaireId, JSON.stringify(window.MouseTracker.getLog()));
      message.textContent = 'Submitted and saved locally';
      setTimeout(()=>message.textContent='',1500);
    }

    // ---- Event Handlers ----

    beginBtn.addEventListener('click', async () => {
      if (!assessment) { setupHint.textContent = 'Assessment not loaded yet'; return; }

      beginBtn.disabled = true;
      setupHint.textContent = 'Loading demographic form...';

      // Try to load configured demographic fields from backend
      const configuredFields = await loadDemographicFields();

      if (configuredFields) {
        // Use backend-configured fields
        renderDemographicsForm(configuredFields);
      } else {
        // No configured fields — use default demographics
        renderDemographicsForm(DEFAULT_DEMOGRAPHICS);
      }

      // Hide setup, show demographics
      document.getElementById('setup').style.display = 'none';
      demographicsCard.style.display = 'block';
    });

    demoContinueBtn.addEventListener('click', async () => {
      demoContinueBtn.disabled = true;
      demoContinueBtn.textContent = 'Saving...';

      const success = await submitDemographics();

      if (success) {
        demographicsCard.style.display = 'none';
        showAllInstructions();
        assessTitle.textContent = assessment.name || 'Untitled';
        assessTool.textContent = assessment.tool?.name ? 'Tool: ' + assessment.tool.name : '';
      }

      demoContinueBtn.disabled = false;
      demoContinueBtn.textContent = 'Save and Continue';
    });

    saveBtn.addEventListener('click', () => {
      const saved = JSON.parse(localStorage.getItem(studentKey) || 'null') || {};
      saved.student = localStorage.getItem('studentName') || saved.student;
      saved.savedAt = new Date().toISOString();
      localStorage.setItem(studentKey, JSON.stringify(saved));
      message.textContent = 'Progress snapshot saved';
      setTimeout(()=>message.textContent='',1000);
    });

    submitBtn.addEventListener('click', submitAssessment);

    // start
    loadAssessment();
  </script>
</body>
</html>
